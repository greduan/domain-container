# Krypton ModelsWrapper Spec

## Index

- [Intro](#intro)
- [Background](#background)
- [Constraints](#constraints)
- [Assumptions](#assumptions)
- [Blackbox](#blackbox)
- [Research](#research)
  - [Prototyping](#prototyping)
- [Technical spec](#technical-spec)
- [Challenges in current development](#challenges-in-current-development)
  - Stuff that will change in current design to allow for this, etc.
- [Operation flow](#operation-flow)
- [Feature summary](#feature-summary)
- [Snippets](#snippets)
  - Examples of usage


## Intro

This document defines a standalone (not related to any particular project)
interface for Krypton models which offers a simple interface to the models while
also providing presenter features.

## Background

Krypton does not provide presenters by default, however it'd be nice to have
them built in to whatever is used to interact with Krypton and it be an
automatic process, instead of having to fetch the models and then give them to
the presenter separately.

In addition there is a need to have a container for the models that has a hold
of their Knex instance, so that it doesn't have to be passed around all the
time.

And it can also hold an unspecified amount of things that the models may need in
the particular project, these are dynamic and specified when instantiating the
wrapper.

## Constraints

- Has to use Neon DRM.
- Has to interface with Krypton ORM seamlessly.
- Has to provide presenters.
- Has to provide a mechanism to pass in (once) an unspecified amount of
  parameters to each model instance, which the instance may need to do its
  thing.

## Assumptions

- The models that it handles are models generated by the Krypton ORM.

## Technical spec

### Class `ModelsWrapper(<Object> initProps)`

`<Object> initProps` available properties:

- `<Knex> knex` a Knex instance which will be used in all the models' queries.
- `<Object> models` an object with all of the models the wrapper will wrap.
  Must be model constructors, not instances.
- `<Object> {Optional} customProps` props that will be handed to every model
  instance that will be used to modify the DB in some way (not query).
- `<Object> {Optional} presenters` presenters for models.

#### Instance variables

These are mostly set by the `<Object> initProps` parameter set and
ModelsWrapper instantiation.

##### `_knex`

Holds the Knex instance that will be provided to every model.

It's set to whatever the `initProps.knex` property was when instantiating the
ModelsWrapper.

##### `_models`

Holds all the models that will be avaialble to the ModelsWrapper.  Must be the
model constructors, not instances.

It's set to whatever the `initProps.models` property was when instantiating the
ModelsWrapper.

##### `_customProps`

Holds the properties that will be passed in to each model whenever it is being
instantiated to modify the DB, i.e. not being used to query.

This could be anything, changes from project to project, but an easy example
would be mailer instances which the models would use, instead of some global
one which isn't configured for the specific models.

It's set to whatever the `initProps.customProps` property was when
instantiating the ModelsWrapper.

##### `presenters`

**NOTICE:** Presenters are currently not used, while how to define them is
defined in this document, they are not in use and thus the rest of the spec will
not define how to make use of them.

Presenters are functions that modify the model they are passed in in order to
make it consumeable by the front end, by removing sensitive data or adding more
data.

The object is made up of properties containing functions, the property name is
the name of the model.  The function would be passed in a model instance which
it would manipulate, the function is expected to return a promise, if the
promise returns a value the model will be replaced by the returned value.

An example `presenters` object would be:

```javascript
presenters: {
  User: function (user) {
    delete user.password;
    delete user.encryptedPassword;
    delete user.token;
    
    return Promise.resolve();
  },
},
```

#### Instance methods

##### `#init(<Object> initProps)`

This method is run whenever the Class is instantiated, i.e. whenever a new
ModelsWrapper instance is created.

```javascript
prototype: {
  _knex: null,
  _models: null,
  _customProps: {},
  presenters: {},

  init: function (initProps) {
    var that = this;
    
    that._knex = initProps.knex;
    that._models = initProps.models;

    if (!_.isUndefined(initProps.customProps)) {
      that._customProps = initProps.customProps;
    }

    if (!_.isUndefined(initProps.presenters)) {
      that.presenters = initProps.presenters;
    }
  },
},
```

##### `#query(<String> modelName)`

This method returns a Krypton QueryBuilder for the requested model.  It returns
an error if the model doesn't exist.

Pseudo-code:

```javascript
prototype: {
  query: function (modelName) {
    var that = this;

    var Model = that._models[modelName];

    if (!Model) {
      throw new Error('Model ' + modelName + ' doesn\'t exist in the ModelsWrapper');
    }

    return Model.query(that._knex);
  },
},
```

##### `#create(<String> modelName, <Object> body)`

This method creates a new entry in the DB with the model provided (identified by
`<String> modelName` parameter) and returns the instance of that model that was
saved.  The contents of the new model are contained in the `<Object> body`
parameter.  It returns an error if the model doesn't exist.

Pseudo-code:

```javascript
prototype: {
  create: function (modelName, body) {
    var that = this;

    var Model = that._models[modelName];

    if (!Model) {
      throw new Error('Model ' + modelName + ' doesn\'t exist in the ModelsWrapper');
    }

    var model = new Model(that._customProps);
    model.updateAttributes(body);

    return model.save(that._knex)
      .then(function () {
        return model;
      });
  },
},
```

##### `#update(<Model> model, <Object> body)`

This method receives a pre-existing model and updates it with the parameters
passed in through the `<Object> body` parameter.

Pseudo-code:

```javascript
protoype: {
  update: function (model, body) {
    var that = this;
    
    model.updateAttributes(body);

    return model.save(that._knex)
      .then(function () {
        return model;
      });
  },
},
```

##### `#delete(<Model> model)`

This method destroys the record in the DB for the provided model (`<Model>
model` parameter).

Pseudo-code:

```javascript
protoype: {
  destroy: function (model) {
    var that = this;
    
    return model.destroy(that._knex)
      .then(function () {
        return model;
      });
  },
},
```

